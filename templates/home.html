{% extends "base.html" %}

{% block load-first %}
  {{ block.super }}
  <style>
    body {
      font-size: 12px;
    }
    div.top-controls {
      display: flex;
      justify-content: space-evenly;
      align-items: center;
      padding: 12px;
      border-bottom: ridge 3px #ca2;
      background-color: #efb02a;
    }
    select {
      padding: 3px;
    }
    select, option {
      font-size: 12px;
    }
    input.datepicker {
      width: 110px;
      padding: 0 5px;
    }
    body {
      width: 100%;
    }
    div.table-container {
      overflow-x: scroll;
      padding: 12px;
    }
    tr.range-subheader-row {
      border-bottom: solid 1px #ca2;
    }
    tr.website-row:nth-child(odd) {
      background-color: #f0f0f0;
    }
    .data-cell {
      text-align: right;
      padding: 2px 3px 2px 0;
    }
    .website-header {
      text-align: center;
      padding: 2px 3px;
    }
    .website-header, .data-cell.rank {
      border-right: solid 3px white;
    }
    .data-cell.price {
      background-color: rgba(255,248,243,0.5);
    }
    .data-cell.markup {
      background-color: rgba(243,255,248,0.5);
    }
    .data-cell.rank {
      background-color: rgba(250,243,253,0.5);
    }
  </style>
{% endblock %}

{% block content %}
  {% include "header.html" %}
  <div class="top-controls">
    <div class="manufacturer-select-container">
      <select>
        <option value=''>Select a manufacturer</option>
      </select>
    </div>
    <div class="parttype-select-container">
      <select>
        {% for t in PartType.CHOICES %}
          <option value='{{ t.0 }}'>{{ t.1 }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="date-select-container">
      <input type="text" class="datepicker" value="{{ yesterday }}">
    </div>
    <button class="run-button" type="button" disabled="disabled">LOAD</button>
  </div>
  <div class="table-container">
  </div>
  <footer></footer>
{% endblock content %}

{% block load-last %}
<script type="text/javascript">
(function() {
  $(".datepicker").datepicker({
    format: "yyyy-mm-dd"
  });

  // Selectors
  var MANUFACTURER_SELECT = ".manufacturer-select-container select";
  var PARTTYPE_SELECT = ".parttype-select-container select";
  var RUN_BUTTON = "button.run-button";
  var TABLE_CONTAINER = "div.table-container";
  var DATE_PICKER = "input.datepicker";

  // State
  var currentManufacturer;
  var currentPartType;
  var currentDate = $(DATE_PICKER).val();
  var websites = [];
  var ranges = [];
  var tableTemplate = null;

  function onFilterChange() {
    currentManufacturer = $(MANUFACTURER_SELECT).val();
    currentPartType = $(PARTTYPE_SELECT).val();
    currentDate = $(DATE_PICKER).val();

    websites = []
    ranges = []
    renderTable()

    if (!!currentManufacturer && !!currentPartType) {
      $(RUN_BUTTON).removeAttr("disabled");
    }
    else {
      $(RUN_BUTTON).attr("disabled", "disabled");
    }
  }

  function renderManufacturerSelect(select, data) {
    const TEMPLATE = "<option value ='{% templatetag openvariable %} id {% templatetag closevariable %}'>{% templatetag openvariable %} name {% templatetag closevariable %}</option>";
    for (var i = 0; i < data.length; ++i) {
      select.append($(Mustache.render(TEMPLATE, data[i])))
    }
  }

  function loadWebsites() {
    getData("website?m=" + currentManufacturer).done(function(data) {
      websites = data;
      renderTable()
      loadPartsPerCostPriceRange()
    })
  }

  function renderTable() {
    if (!tableTemplate) {
      $.get("/static/table.mustache").done(function(data) {
        tableTemplate = data;
        renderTable()
      });
    }
    else {
      tableHtml = Mustache.render(tableTemplate, { ranges: ranges, websites: websites });
      $(TABLE_CONTAINER).empty().append($(tableHtml))
      $(TABLE_CONTAINER).find(".product-choice").on("change", handlePartSelectionChange);
    }
  }

  function loadPartsPerCostPriceRange() {
    getData("parts/per_cost_price_range?m=" + currentManufacturer + "&t=" + currentPartType).done(function(data) {
      ranges = data;
      renderTable();
      loadAllPartPrices();
    })
  }

  function loadAllPartPrices() {
    $(".data-cell").text("");
    for (var i = 0; i < ranges.length; ++i) {
      var rangeObj = ranges[i];
      if (rangeObj.parts && rangeObj.parts.length) {
        loadPartPrice(rangeObj.parts[0], rangeObj.range)
      }
    }
  }

  function loadPartPrice(partNumber, range) {
    getData("part/" + partNumber + "/pricing_on_date?d=" + currentDate).done(function(data) {
      for (var website in data.by_website) {
        var values = data.by_website[website];
        for (var field in { "price": 1, "markup": 1, "rank": 1 }) {
          $(".data-cell." + field + "[data-website='" + website + "'][data-range='" + range + "']").text(values[field]);
        }
      }
    })
  }

  function handlePartSelectionChange() {
    var target = $(this);
    var partNumber = target.val();
    var range = target.attr("data-range");
    console.log(partNumber, range);
    loadPartPrice(partNumber, range)
  }

  whenPageLoaded(function() {
    getData("manufacturer").done(function(data) {
      renderManufacturerSelect($(MANUFACTURER_SELECT), data)
    })
    $(PARTTYPE_SELECT).on("change", onFilterChange)
    $(MANUFACTURER_SELECT).on("change", onFilterChange)
    $(DATE_PICKER).on("change", onFilterChange)
    $(RUN_BUTTON).on("click", loadWebsites)
  })
})();
</script>
{% endblock load-last %}
