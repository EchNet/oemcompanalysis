{% extends "base.html" %}

{% block load-first %}
  {{ block.super }}
  <style>
    div.top-controls {
      margin-top: 4px;
      display: flex;
      justify-content: space-evenly;
      align-items: center;
    }
    select {
      padding: 3px;
    }
    select, option {
      font-size: 16px;
    }
    input.datepicker {
      width: 110px;
      padding: 0 5px;
    }
    body {
      width: 100%;
    }
    div.table-container {
      overflow-x: scroll;
    }
  </style>
{% endblock %}

{% block content %}
  {% include "header.html" %}
  <div class="top-controls">
    <div class="manufacturer-select-container">
      <select>
        <option value=''>Select a manufacturer</option>
      </select>
    </div>
    <div class="parttype-select-container">
      <select>
        <option value=''>Select a type</option>
        {% for t in PartType.CHOICES %}
          <option value='{{ t.0 }}'>{{ t.1 }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="date-select-container">
      <input type="text" class="datepicker" value="{{ yesterday }}">
    </div>
    <button class="run-button" type="button" disabled="disabled">RUN</button>
  </div>
  <div class="table-container">
  </div>
  <footer></footer>
{% endblock content %}

{% block load-last %}
<script type="text/javascript">
(function() {
  $(".datepicker").datepicker({
    format: "yyyy-mm-dd"
  });

  // Selectors
  var MANUFACTURER_SELECT = ".manufacturer-select-container select";
  var PARTTYPE_SELECT = ".parttype-select-container select";
  var RUN_BUTTON = "button.run-button";
  var TABLE_CONTAINER = "div.table-container";
  var DATE_PICKER = "input.datepicker";

  // State
  var currentManufacturer;
  var currentPartType;
  var currentDate = $(DATE_PICKER).val();
  var websites = [];
  var ranges = [];
  var tableTemplate = null;

  function onFilterChange() {
    var manufacturer = $(MANUFACTURER_SELECT).val();
    var partType = $(PARTTYPE_SELECT).val();
    if (manufacturer != currentManufacturer || partType != currentPartType) {
      websites = []
      ranges = []
      renderTable()
    }
    if (!!manufacturer && !!partType) {
      $(RUN_BUTTON).removeAttr("disabled");
    }
    else {
      $(RUN_BUTTON).attr("disabled", "disabled");
    }
  }

  function onDateChange() {
    var selectedDate = $(DATE_PICKER).val();
    if (selectedDate != currentDate) {
      $(".data-cell").text("");
      currentDate = selectedDate;
    }
  }

  function renderManufacturerSelect(select, data) {
    const TEMPLATE = "<option value ='{% templatetag openvariable %} id {% templatetag closevariable %}'>{% templatetag openvariable %} name {% templatetag closevariable %}</option>";
    for (var i = 0; i < data.length; ++i) {
      select.append($(Mustache.render(TEMPLATE, data[i])))
    }
  }

  function loadWebsites() {
    var selectedManufacturer = $(MANUFACTURER_SELECT).val()
    var selectedPartType = $(PARTTYPE_SELECT).val()
    if (selectedManufacturer != currentManufacturer || selectedPartType != currentPartType) {
      currentManufacturer = selectedManufacturer;
      currentPartType = selectedPartType;
      getData("website?m=" + currentManufacturer).done(function(data) {
        websites = data;
        renderTable()
        loadPartsPerCostPriceRange()
      })
    }
  }

  function renderTable() {
    if (!tableTemplate) {
      $.get("/static/table.mustache").done(function(data) {
        tableTemplate = data;
        renderTable()
      });
    }
    else {
      tableHtml = Mustache.render(tableTemplate, { ranges: ranges, websites: websites });
      $(TABLE_CONTAINER).empty().append($(tableHtml))
    }
  }

  function loadPartsPerCostPriceRange() {
    getData("parts/per_cost_price_range?m=" + currentManufacturer + "&t=" + currentPartType).done(function(data) {
      ranges = data;
      renderTable();
      loadAllPartPrices();
    })
  }

  function loadAllPartPrices() {
    $(".data-cell").text("");
    for (var i = 0; i < ranges.length; ++i) {
      loadPartPrice(ranges[i]);
    }
  }

  function loadPartPrice(rangeObj) {
    if (rangeObj.parts && rangeObj.parts.length) {
      getData("part/" + rangeObj.parts[0] + "/pricing_on_date?d=" + currentDate).done(function(data) {
        console.log(data);
        for (var website in data.by_website) {
          var values = data.by_website[website];
          for (var field in { "price": 1, "markup": 1, "rank": 1 }) {
            $(".data-cell." + field + "[data-website='" + website + "'][data-range='" + rangeObj.range + "']").text(values[field]);
          }
        }
      })
    }
  }

  whenPageLoaded(function() {
    getData("manufacturer").done(function(data) {
      renderManufacturerSelect($(MANUFACTURER_SELECT), data)
    })
    $(PARTTYPE_SELECT).on("change", onFilterChange)
    $(MANUFACTURER_SELECT).on("change", onFilterChange)
    $(RUN_BUTTON).on("click", loadWebsites)
  })
})();
</script>
{% endblock load-last %}
